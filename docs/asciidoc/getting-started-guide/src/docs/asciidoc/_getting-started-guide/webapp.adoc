// Licensed to the Apache Software Foundation (ASF) under one or more
// contributor license agreements. See the NOTICE file distributed with
// this work for additional information regarding copyright ownership.
// The ASF licenses this file to you under the Apache License, Version
// 2.0 (the "License"); you may not use this file except in compliance
// with the License. You may obtain a copy of the License at
//
// http://www.apache.org/licenses/LICENSE-2.0 Unless required by
// applicable law or agreed to in writing, software distributed under the
// License is distributed on an "AS IS" BASIS, WITHOUT WARRANTIES OR
// CONDITIONS OF ANY KIND, either express or implied. See the License for
// the specific language governing permissions and limitations under the
// License.
== Converting to Web Application
This chapter shows how to work with Cayenne in a web application.

=== Converting Tutorial to a Web Application
The web part of the web application tutorial is done as RESTful application.
A typical Cayenne web application works like this:

- Cayenne configuration is loaded when an application context is started, using Jersey DI container.
- New ObjectContext is created for each request.

So let's convert the tutorial that we created to a web application:

- First you need to create `CayenneServerRuntimeFactory` for injecting `ServerRuntime` to your service:

.CayenneServerRuntimeFactory.java
[source,java]
----
include::{java-include-dir}/config/CayenneServerRuntimeFactory.java[tag=content]
----

- Then create `CayenneConfig` what is the basis of the application:

.CayenneConfig.java
[source,java]
----
include::{java-include-dir}/config/CayenneConfig.java[tag=content]
----

- In IDEA under "tutorial" project folder create a new folder `src/main/webapp/WEB-INF`.
- Under `WEB-INF` create a new file `web.xml` (a standard web app descriptor):

.web.xml
[source,xml]
----
<web-app xmlns="http://java.sun.com/xml/ns/j2ee" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://java.sun.com/xml/ns/j2ee http://java.sun.com/xml/ns/j2ee/web-app_2_4.xsd"
         version="2.4">
    <display-name>Cayenne Rest Demo</display-name>

    <servlet>
        <servlet-name>Cayenne Rest Demo</servlet-name>
        <servlet-class>org.glassfish.jersey.servlet.ServletContainer</servlet-class>
        <init-param>
            <param-name>javax.ws.rs.Application</param-name>
            <param-value>org.apache.cayenne.tutorial.config.CayenneConfig</param-value>
        </init-param>
        <load-on-startup>1</load-on-startup>
    </servlet>
    <servlet-mapping>
        <servlet-name>Cayenne Rest Demo</servlet-name>
        <url-pattern>/cayenne/*</url-pattern>
    </servlet-mapping>

</web-app>
----

- Next step is to create POJO classes for your entities. It will allow us to return JSON objects as responses.
For example POJO object for `Artist` might look like:

.ArtistPojo.java
[source,java]
----
include::{java-include-dir}/pojo/ArtistPojo.java[tag=content]
----

- Create POJOs for other entities.

- Finally you need to create resource class.

.CayenneResource.java
[source,java]
----
include::{java-include-dir}/resource/CayenneResource.java[tag=content]
----

==== Running Web Application

We need to add jersey-container-servlet, jersey-hk2, jersey-media-json-jackson and
javax servlet-api for our application.

.pom.xml
[source,xml]
----
<dependency>
    <groupId>org.glassfish.jersey.containers</groupId>
    <artifactId>jersey-container-servlet</artifactId>
    <version>2.28</version>
</dependency>
<dependency>
    <groupId>org.glassfish.jersey.inject</groupId>
    <artifactId>jersey-hk2</artifactId>
    <version>2.28</version>
</dependency>
<dependency>
    <groupId>org.glassfish.jersey.media</groupId>
    <artifactId>jersey-media-json-jackson</artifactId>
    <version>2.28</version>
</dependency>
<dependency>
    <groupId>javax.servlet</groupId>
    <artifactId>javax.servlet-api</artifactId>
    <version>4.0.1</version>
    <scope>provided</scope>
</dependency>
----

Also to run the web application we'll use "maven-jetty-plugin". To activate it,
let's add the following piece of code to the `pom.xml` file, following the "dependencies"
section and save the POM:

.pom.xml
[source,xml]
----
<build>
    <plugins>
        <plugin>
            <groupId>org.eclipse.jetty</groupId>
            <artifactId>jetty-maven-plugin</artifactId>
            <version>9.4.15.v20190215</version>
        </plugin>
    </plugins>
</build>
----

- Go to "Select Run/Debug Configuration" menu, and then "Edit Configuration..."

image::idea-edit-configurations.png[align="center"]


- Click `+` button and select "Maven". Enter "Name" and "Command line" as shown on screenshot:

image:idea-run-configuration.png[]

- Click "Apply" and "Run". On the first execution it may take a few minutes for
Jetty plugin to download all dependencies, but eventually you'll see the logs
like this:

    [INFO] ------------------------------------------------------------------------
    [INFO] Building tutorial 0.0.1-SNAPSHOT
    [INFO] ------------------------------------------------------------------------
    ...
    [INFO] Configuring Jetty for project: tutorial
    [INFO] webAppSourceDirectory not set. Trying src/main/webapp
    [INFO] Reload Mechanic: automatic
    [INFO] Classes = /.../tutorial/target/classes
    [INFO] Logging initialized @1617ms
    [INFO] Context path = /
    [INFO] Tmp directory = /.../tutorial/target/tmp
    [INFO] Web defaults = org/eclipse/jetty/webapp/webdefault.xml
    [INFO] Web overrides =  none
    [INFO] web.xml file = file:/.../tutorial/src/main/webapp/WEB-INF/web.xml
    [INFO] Webapp directory = /.../tutorial/src/main/webapp
    [INFO] jetty-9.3.0.v20150612
    [INFO] Started o.e.j.m.p.JettyWebAppContext@6872f9c8{/,file:/.../tutorial/src/main/webapp/,AVAILABLE}{file:/.../tutorial/src/main/webapp/}
    [INFO] Started ServerConnector@723875bc{HTTP/1.1,[http/1.1]}{0.0.0.0:8080}
    [INFO] Started @2367ms
    [INFO] Started Jetty Server</screen>

- So the Jetty container just started.

- Now you can create new artist using `curl -X POST 'http://localhost:8080/cayenne/artist?name=Picasso&date=18811125'`

- Get all artists using `curl -X GET 'http://localhost:8080/cayenne/artists'`

- Modify artist by id using `curl -X PUT 'http://localhost:8080/cayenne/artist/200?name=NewName'`

You are done with the tutorial!